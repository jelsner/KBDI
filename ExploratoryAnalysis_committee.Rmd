---
title: "ExploratoryAnalysis_Committee"
author: "Zach"
date: "5/27/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This file will explore ideas proposed by the committee during the prospectus defense on 5/25/2021


### Checking Value of Q

It is expected that with time KBDI plots will become equal regardless of the initial value of Q


Copy and paste KBDI code

## Import the summary of the day data and add columns to the data frame

Assign no rainfall on days with missing values.

For Tallahassee Station TLH
```{r}
library(lubridate)
library(tidyverse)
TLH.df <- read_csv(file = 'Data/TLH_Daily1940.csv') %>%
  rename(Date = DATE) %>%
  mutate(Year = year(Date), 
         month = month(Date, label = TRUE, abbr = TRUE),
         doy = yday(Date),
         MaxTemp = TMAX,
         MinTemp = TMIN,
         Rainfall24 = PRCP,
         Rainfall24 = replace_na(Rainfall24, 0),
         Rainfall24mm = Rainfall24 * 25.4)
```

Fill in the missing temperature data.
```{r}
TLH.df$MaxTemp[TLH.df$Date == "2005-07-08"] <- 96
```


A new data frame is created to compare initial Q values. Q is representative of the starting value of KBDI. Here a column of several Q values is created to be used and compared among multiple plots. Daily KBDI is calculated for each initial Q value. This is testing the theory that with enough time elapsed, the initial value of Q does not matter.

Could drought index be made a function to make this easier?
```{r}
Rainfall24 <- TLH.df$Rainfall24
PR <- dplyr::lag(Rainfall24)
PR[1] <- 0
CumR <- 0
NetR <- numeric()
for(i in 1:length(Rainfall24)) {
  R24 <- Rainfall24[i]
  if (R24 == 0) {
    NetR[i] <- 0
    CumR <- 0
  } 
  else if(R24 > 0 & R24 <= .2) {
      CumR <- CumR + R24
      if (PR[i] > .2 | CumR > .2) NetR[i] <- R24
      else if (CumR > .2) NetR[i] <- CumR - .2
      else NetR[i] <- 0
    }
  else if (R24 > .2) {
      if (CumR <= .2) {
      NetR[i] <- CumR + R24 - .2
      CumR <- CumR + R24
      }
      else {
      NetR[i] <- R24
      CumR <- CumR + R24
      }
  }
}

TLH.df$NetR <- NetR
R <- 59.23

rangeQ.df <- TLH.df %>%
  select(Date, Rainfall24, MaxTemp, NetR)

for(i in 1:9){
  Q2 <- i-1
  Q <- Q2*100
  MaxTemp <- TLH.df$MaxTemp
  Ql <- numeric()
  for(i in 1:length(Rainfall24)){
    DeltaQ <- (800 - Q) * (.968 * exp(.0486 * MaxTemp[i]) - 8.3) /(1 + 10.88 * exp(-.0441 * R)) * .001 
    Q <- ifelse(NetR[i] == 0,  Q + DeltaQ,  (Q + DeltaQ) - NetR[i] * 100)
    Q <- ifelse(Q < 0, 0, Q) 
    Ql <- c(Ql, Q)
  }
  rangeQ.df[, ncol(rangeQ.df)+1] <- Ql
  colnames(rangeQ.df) <- c("Date", "Rainfall24", "MaxTemp", "NetR", "Q0", "Q100", "Q200", "Q300", "Q400", "Q500", "Q600", "Q700", "Q800")
}
```

```{r}
head(rangeQ.df)
```



```{r}
library(lubridate)
library(ggplot2)

rangeQ.df %>% 
  filter(year(Date) == 1940) %>%
  ggplot(mapping = aes(x = Date)) +
    geom_line(aes(y = Q0), colour = "red") +
    geom_line(aes(y = Q400), colour = "blue") + 
    geom_line(aes(y = Q800))
``` 



```{r}
library(lubridate)
library(ggplot2)

rangeQ.df %>% 
  filter(year(Date) == 1940) %>%
  filter(month(Date) == '6' | month(Date) == '7' | month(Date) == '8') %>%
  ggplot(mapping = aes(x = Date)) +
    geom_line(aes(y = Q0), colour = "red") +
    geom_line(aes(y = Q400), colour = "blue") + 
    geom_line(aes(y = Q800))
``` 






##Explore lightning data and concerns mentioned by committee.

Get lightning data

Daily county-level counts 1986-2013. Data location: https://www1.ncdc.noaa.gov/pub/data/swdi/reports/county/byFips/
Note: this data is not spatial and cannot be bounded by the ANF.For exploratory analysis purposes, this data will be explored across counties that the ANF is within. These counties are Liberty, Wakulla, Franklin, and Leon.

First get the Florida fips codes for Liberty, Wakulla, Franklin and Leon counties, then get the data.
```{r}
library(tidycensus)

FLfips <- fips_codes %>%
  filter(state == "FL") %>%
  filter(county %in% c("Liberty County", "Wakulla County", "Franklin County", "Leon County")) %>%
  pull(county_code)

fn <- paste0("https://www1.ncdc.noaa.gov/pub/data/swdi/reports/county/byFips/swdireport-12", FLfips, "-BETA.csv")

lightningdata.df <- data.frame()
for(i in 1:length(fn)){
  X <- read.csv(fn[i], na.strings = "NULL", header = TRUE, stringsAsFactors = FALSE)
  lightningdata.df <- rbind(lightningdata.df, X)
}

lightningdata.df <- lightningdata.df %>%
  mutate(SEQDAY = as.Date(SEQDAY),
         DAY = day(SEQDAY),
         MONTH = month(SEQDAY),
         YEAR = year(SEQDAY))
```

lightningdata.df gives lighting data for each individual county based on fips code. Combine total lightning strikes in ANF counties by date.
```{r}
countlightning.df <- lightningdata.df %>%
  group_by(SEQDAY) %>%
  summarise(FCOUNT_NLDN = sum(FCOUNT_NLDN)) %>%
  rename(ANFcountiesCount = FCOUNT_NLDN)
```

Explore relationship between high lightning count days and number of lightning sparked wildfires in the ANF

Import Forest Boundaries to explore lightning firedata in ANF
```{r}
library(tidyverse)
library(sf)

if(!"S_USA.NFSLandUnit" %in% list.files()){
  download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.NFSLandUnit.zip",
                "S_USA.NFSLandUnit.zip")
unzip("S_USA.NFSLandUnit.zip")
}

NF_Bounds.sf <- st_read(dsn = "s_USA.NFSLandUnit.shp") %>%
  st_transform(crs = 3086)

anfbounds.sf <- NF_Bounds.sf %>%
  filter(NFSLANDU_2 == "Apalachicola National Forest")
```

Import fire data
```{r}
if(!"FL_Fires" %in% list.files()){
download.file("http://myweb.fsu.edu/jelsner/temp/data/FL_Fires.zip",
"FL_Fires.zip")
unzip("FL_Fires.zip")
}
FL_Fires.sf <- st_read(dsn = "FL_Fires") %>%
st_transform(crs = 3086)

anf_fires.sf <- st_join(FL_Fires.sf, anfbounds.sf, join = st_within) %>%
  filter(NFSLANDU_2 == 'Apalachicola National Forest')
```

Filtered for Lightning
```{r}
anf_LF.sf <- anf_fires.sf %>%
  filter(STAT_CAU_1 == "Lightning")
```

create data set containing fires and lightning counts. Match years for data sets (2005 - 2013)
```{r}
exploreLF <- anf_LF.sf %>%
  filter(FIRE_Y <= 2013)
exploreCount <- countlightning.df %>%
  filter(year(SEQDAY) >= 1992)


exploratory <- merge(x = anf_LF.sf, y = countlightning.df, by.x = c("DISCOVERY_"), by.y = c("SEQDAY"))
#exploratorytest <- merge(x = exploreLF, y = exploreCount, by.x = c("DISCOVERY_"), by.y = c("SEQDAY"))
```


Explore the frequency of fires for high lightning count days.
```{r}
datefirecounts <- exploratory %>%
  count(DISCOVERY_, ANFcountiesCount) %>%
  rename(FireCount = n, LightningCount = ANFcountiesCount) %>%
  group_by()
```


A linear regression model shows a p-value > 0.05 and suggests the number of lightning strikes does not have a significant roll in the outcome of if a lightning strike creating a fire.
```{r}
datefirecounts.lm <- lm(FireCount ~ LightningCount, data = datefirecounts)
summary(datefirecounts.lm)
```

Plotting the data suggest that the number of lighting strikes does not have a significant impact on the frequency of a fire that occur.
```{r}
datefirecounts %>%
ggplot(mapping = aes(x = LightningCount, y = FireCount)) +
  geom_point()
```

```{r}
datefirecounts %>%
  filter(LightningCount <= 1000) %>%
  ggplot(mapping = aes(x = LightningCount, y = FireCount)) +
  geom_point()
```


Does a higher lightning count correspond to more rainfall? Would high rainfall values help to saturate the fuel and limit the spread/ ignition of lightning cause wildfires? Plots and a p-value greater than 0.05 suggest there is no relationship between the number of lightning strikes and the amount of rainfall on a given day.
```{r}
lightningRainfall <- merge(x = TLH.df, y = exploreCount, by.x = c("Date"), by.y = c("SEQDAY"))

lightningRainfall<- lightningRainfall %>%
  select("Date", "PRCP", "ANFcountiesCount") %>%
  rename(LightningCount = ANFcountiesCount) %>%
  filter(LightningCount > 0)
```


plot lightning to precip
```{r}
lightningRainfall %>%
  ggplot(mapping = aes(x = LightningCount, y = PRCP)) +
  geom_point()
```

```{r}
lightningRainfall.lm <- lm(PRCP ~ LightningCount, data = lightningRainfall)
summary(datefirecounts.lm)
```

Does this relationship exist during the convective months of our statistically defined fire season?
```{r}
lightningRainfall %>%
  filter(month(Date) == 05 | month(Date) == 06 | month(Date) == 07) %>%
  ggplot(mapping = aes(x = LightningCount, y = PRCP)) +
  geom_point()
```




of 2898 days with lightning in this data set, fires occurred on 235 of those days. 8.12% of days with lightning sparked a wildfire
```{r}
forBool <- left_join(x = exploreCount, y = exploreLF, by = c("SEQDAY" = "DISCOVERY_")) %>%
  select("SEQDAY", "ANFcountiesCount", "FOD_I") %>%
  rename(Date = SEQDAY, LCount = ANFcountiesCount) %>%
  #a lightning fire cannot occur on a day without lighting
  filter(LCount >0) %>%
  #multiple fires occurring on one day will count as one event
  distinct(Date, .keep_all = TRUE)

forBool %>%
  count("Date")

forBool %>%
  count(FOD_I != "NA")

forBool$fireBool <- !is.na(forBool$FOD_I)

sum(forBool$fireBool) / as.double(length(forBool$fireBool)) * 100
```

There are 561 days with a lightning count greater than or equal to 500. Lightning sparked wildfires on 97 of those days (17.29%)
```{r}
Lcount200 <- forBool %>%
  filter(LCount >= 200)

Lcount200 %>%
  count("Date")

Lcount1500 <- forBool %>%
  filter(LCount >= 1500)
```


Find the percent likelihood a fire occurs based on the number of lightning strikes on a given day.
The most lightning strikes in a day is 5588
```{r}
LightningStats <- data.frame(Filter = integer(0), LightningDays = integer(0), FireDays = double(0), Percent = double(0))
#LightningStats[1,] <- 1:4
LightningStats[nrow(LightningStats)+1,] <- NA

LightningStats$Filter <- 0
LightningStats$LightningDays <- as.double(length(forBool$fireBool))
LightningStats$FireDays <- sum(forBool$fireBool)
LightningStats$Percent <- (LightningStats$FireDays / LightningStats$LightningDays) * 100

for (i in 1:22){
  LightningStats[nrow(LightningStats)+1,] <- NA
  x <- i*250
  LightningStats$Filter[i] <- x
  filterLoop <- forBool %>%
    filter(LCount >= x)
  LightningStats$LightningDays[i] <-  as.double(length(filterLoop$fireBool))
  LightningStats$FireDays[i] <- sum(filterLoop$fireBool)
  LightningStats$Percent[i] <- (LightningStats$FireDays[i] / LightningStats$LightningDays[i]) * 100
}

#LightningStats <- LightningStats[-c(23)]
```

Plot the likelihood of a fire occurring based on the amount of lighting in a storm
```{r}
ggplot(data = LightningStats,
       mapping = aes(y = Percent, 
                     x = Filter,
                     fill = Percent)) +
  geom_col() +
  scale_fill_distiller(palette = "Oranges",
                      direction = 1,
                       guide = FALSE) +
  #xlab("") + ylab("") +
  labs(title = "Likelihood a Lightning Stike Starts a Wildfire",
       subtitle = "Filtered by # of Lightning Strikes increasing by 250") +
  theme_minimal() 
```


Explore Lightning Statistics for fire season months
```{r}
LightningStatsFS <- data.frame(Filter = integer(0), LightningDays = integer(0), FireDays = double(0), Percent = double(0))
#LightningStats[1,] <- 1:4
LightningStatsFS[nrow(LightningStatsFS)+1,] <- NA

forBoolFS <- forBool %>%
  filter(month(Date) == 05 | month(Date) == 06 | month(Date) == 07)

LightningStatsFS$Filter <- 0
LightningStatsFS$LightningDays <- as.double(length(forBoolFS$fireBool))
LightningStatsFS$FireDays <- sum(forBoolFS$fireBool)
LightningStatsFS$Percent <- (LightningStatsFS$FireDays / LightningStatsFS$LightningDays) * 100

for (i in 1:20){
  LightningStatsFS[nrow(LightningStatsFS)+1,] <- NA
  x <- i*250
  LightningStatsFS$Filter[i] <- x
  filterLoop <- forBoolFS %>%
    filter(LCount >= x)
  LightningStatsFS$LightningDays[i] <-  as.double(length(filterLoop$fireBool))
  LightningStatsFS$FireDays[i] <- sum(filterLoop$fireBool)
  LightningStatsFS$Percent[i] <- (LightningStatsFS$FireDays[i] / LightningStatsFS$LightningDays[i]) * 100
}
```



Plot for fire season months.
```{r}
ggplot(data = LightningStatsFS,
      mapping = aes(y = Percent, 
                   x = Filter,
                   fill = Percent)) +
  geom_col() +
  scale_fill_distiller(palette = "Oranges",
                      direction = 1,
                       guide = FALSE) +
  #xlab("") + ylab("") +
  labs(title = "Likelihood a Lightning Stike Starts a Wildfire (May - July)",
       subtitle = "Filtered by # of Lightning Strikes increasing by 250") +
  theme_minimal() 
```







Explore if the occurrence of a large fire creates a time lag in the occurrence of another fire.Studying this question finds inconclusive results. The fires in this data set are not large enough, and only 2 fires occur within the burned area.

There are 6 fires larger than 600 acres (~2.5 km^2) in this data set
```{r}
anf_LF.sf %>%
  count(FIRE_SIZE >= 600) %>%
  head()
```

```{r}
library(tmap)
library(rgeos)

tmap_mode("view")

buffer <- anf_LF.sf %>%
  filter(FIRE_SIZE >= 600) %>%
  #buffer defaults to meters?
  st_buffer(2500)

tm_shape(anfbounds.sf) +
  tm_borders() +

anf_LF.sf %>%
  filter(FIRE_SIZE >= 600) %>%
  tm_shape() +
  tm_dots( "red") +

anf_LF.sf %>% 
  filter(FIRE_SIZE < 600) %>%
  tm_shape() +
  tm_dots("yellow") +
  
buffer %>%
  tm_shape() +
  tm_borders(col = "black")

```

```{r}
bufferContains <- st_join(anf_LF.sf, buffer, join = st_within) %>%
  filter(FOD_I.y != "NA") %>%
  select("FOD_I.y", "FOD_I.x", "DISCOVERY_.y", "DISCOVERY_.x", "FIRE_SIZE.x") %>%
  filter(FOD_I.x != FOD_I.y) %>%
  rename(FOD_I.buffer = FOD_I.y, FOD_I = FOD_I.x, DISCOVERY_.buffer = DISCOVERY_.y, DISCOVERY_ = DISCOVERY_.x, FIRE_SIZE = FIRE_SIZE.x) %>%
  group_by(FOD_I.buffer) %>%
  #fires in the 117094 were all reported on the same date. Assumed to be same event.Filter out
  filter(FOD_I.buffer != 117094)

bufferContains$diff_in_days<- difftime(bufferContains$DISCOVERY_ ,bufferContains$DISCOVERY_.buffer , units = c("days"))

#If diff_in_days is negative, fire occurred before large fire
bufferContains <- bufferContains %>%
  filter(diff_in_days > 0) 
```




###Still Working on this
Further exploring fire and drought data before starting larger regression models:
Plot data and explore trends.

```{r}
Rainfall24 <- TLH.df$Rainfall24
PR <- dplyr::lag(Rainfall24)
PR[1] <- 0

CumR <- 0
NetR <- numeric()

for(i in 1:length(Rainfall24)) {
  R24 <- Rainfall24[i]
  if (R24 == 0) {
    NetR[i] <- 0
    CumR <- 0
  } 
  else if(R24 > 0 & R24 <= .2) {
      CumR <- CumR + R24
      if (PR[i] > .2 | CumR > .2) NetR[i] <- R24
      else if (CumR > .2) NetR[i] <- CumR - .2
      else NetR[i] <- 0
    }
  else if (R24 > .2) {
      if (CumR <= .2) {
      NetR[i] <- CumR + R24 - .2
      CumR <- CumR + R24
      }
      else {
      NetR[i] <- R24
      CumR <- CumR + R24
      }
  }
}

TLH.df$NetR <- NetR

Q <- 269  
R <- 59.23 # average annual rainfall for TLH in inches

MaxTemp <- TLH.df$MaxTemp

Ql <- numeric()
DeltaQl <- numeric()
for(i in 1:length(Rainfall24)){
  DeltaQ <- (800 - Q) * (.968 * exp(.0486 * MaxTemp[i]) - 8.3) /(1 + 10.88 * exp(-.0441 * R)) * .001 
  Q <- ifelse(NetR[i] == 0,  Q + DeltaQ,  (Q + DeltaQ) - NetR[i] * 100)
  Q <- ifelse(Q < 0, 0, Q) 
  Ql <- c(Ql, Q)
  DeltaQl <- c(DeltaQl, DeltaQ)
}

TLH.df$Ql <- Ql
TLH.df$Qlm <- Ql * .254  # tenth of an inch to mm
TLH.df$DeltaQl <- DeltaQl
TLH.df$DroughtIndex <- floor(Ql/100)

TLH.df <- TLH.df %>%
 dplyr::filter(Year >= 1946 & Year <= 2019) # Only full years
```

```{r}
droughtFire <- merge(x = anf_LF.sf, y = TLH.df, by.x = c("DISCOVERY_"), by.y = c("Date"))

droughtFire <- droughtFire %>%
  select("Date", "Qlm", "FIRE_SIZE")
```




