---
title: "SEDAAG"
author: "Zach"
date: "10/2/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This file will document/organize work flow as it will be presented at the SEDAAG conference


##Abstract
Seasonal Prediction of Natural Fires in the Apalachicola National Forest

Anthropogenic climate change is shifting the risk of wildfires worldwide. The influence of climate change on fire hazards are diverse and complex and varying by region. Understandably, literature on the U.S. wildfire threat holds a western centric viewpoint. In this study we investigate the fire threat in the Southeast United States. In particular, we examine the association between soil dryness and lightning-ignited wildfires in the Apalachicola National Forest (ANF) located in the Florida Big Bend region. We quantify, for the first time, the relationship between pre-fire season dryness and the number of fires during the fire season with a statistical model. We show that lightning-ignited wildfires are frequent, seasonal events. We define the fire season as occurring from May to July when over 80% of natural fires since 1992 have occurred. We show a strong relationship between dryness in the forest duff layer during April and the number of natural wildfires during the subsequent May through July time period. We estimate soil dryness in the duff layer using the Keetch-Byram Drought Index (KBDI) which is a measure of moisture deficit based on temperature and net rainfall easily computed using daily summary of the day values from first-order weather stations. Given the strong relationship between the KBDI and the number of wildfires we suggest that a skillful seasonal prediction model of fire-season severity might be possible.

##Import libraries and data sets
```{r}
library(lubridate)
library(tidyverse)
library(ggplot2)
#library(ggrepel)
library(scales)
library(patchwork)
library(tidycensus)
library(dplyr)
library(readr)
library(sf)
library(tmap)
library(rgeos)
library(RColorBrewer)
library(rgdal)
library(USAboundaries)
library(XML)
```

Daily summary of the day values from Tallahassee (TLH)
March 1,1940 - April 20, 2020
Includes observed 24hr precip, tmax, and tmin
```{r}
TLH.df <- read_csv(file = 'Data/TLH_Daily1940.csv') %>%
  rename(Date = DATE) %>%
  mutate(Year = year(Date), 
         month = month(Date, label = TRUE, abbr = TRUE),
         doy = yday(Date),
         MaxTemp = TMAX,
         MinTemp = TMIN,
         Rainfall24 = PRCP,
         Rainfall24 = replace_na(Rainfall24, 0),
         Rainfall24mm = Rainfall24 * 25.4)

#Fill in the missing temperature data
TLH.df$MaxTemp[TLH.df$Date == "2005-07-08"] <- 96
```

Calculate KBDI referencing functions that have been built. Append to TLH.df
```{r}
source("netRainfall.R")
TLH.df$NetR <- netRainfall(TLH.df$Rainfall24)

source("droughtIndex.R")
Q <- 269
R <- 59.23 #Average annual rainfall for TLH in inches
TLH.df$Ql <- droughtIndex(Q,R,TLH.df$MaxTemp,TLH.df$NetR)$Ql
TLH.df$Qlm <- TLH.df$Ql * .254  # tenth of an inch to mm
TLH.df$DroughtIndex <- droughtIndex(Q,R,TLH.df$MaxTemp,TLH.df$NetR)$DroughtIndex
```

ANF Boundaries data set:
```{r}
if(!"S_USA.NFSLandUnit" %in% list.files()){
  download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.NFSLandUnit.zip",
                "S_USA.NFSLandUnit.zip")
unzip("S_USA.NFSLandUnit.zip")
}

NF_Bounds.sf <- st_read(dsn = "s_USA.NFSLandUnit.shp") %>%
  st_transform(crs = 3086)

anfbounds.sf <- NF_Bounds.sf %>%
  filter(NFSLANDU_2 == "Apalachicola National Forest")
```

Import County Boundaries of the forest. This will make the bounds consistent across both the fire data set and the lightning data set.
```{r}
ANFcountyBounds.sf <- st_read(dsn = "ANFCounties.shp") %>%
  st_transform(crs = 3086)
```

Fires data set:
bounded on counties to match the lightning data boundary. Includes Liberty, Wakulla, Franklin, and Leon. ANF is within these county boundaries.Includes all fire types.
```{r}
#if(!"Fires2018" %in% list.files()){
  #download.file("https://www.fs.usda.gov/rds/archive/products/RDS-2013-0009.5/RDS-2013-0009.5_GPKG.zip",
                #"Data/updatedFireData/Fires2018.zip")
  #unzip("Data/updatedFireData/Fires2018.zip",
        #exdir = "Data/updatedFireData")
#}

county_Fires.sf <- st_read(dsn = "Data/updatedFireData/Data/FPA_FOD_20210617.gpkg", layer = "Fires") %>%
  filter(STATE == "FL") %>%
  st_transform(crs = st_crs(ANFcountyBounds.sf)) %>%
  st_intersection(ANFcountyBounds.sf) %>%
  select(FOD_ID, FIRE_NAME, FIRE_YEAR, DISCOVERY_DATE, NWCG_CAUSE_CLASSIFICATION, NWCG_GENERAL_CAUSE, FIRE_SIZE, FIRE_SIZE_CLASS, LATITUDE, LONGITUDE, NAME, FIPS_CODE, Shape)

#Reformat date column to not include time. Rename to match other merged columns
county_Fires.sf$DISCOVERY_DATE <- as.Date(county_Fires.sf$DISCOVERY_DATE)
county_Fires.sf <- county_Fires.sf %>%
  rename(DISCOVERY_ = DISCOVERY_DATE)
```

Bounded to the ANF
```{r}
#all fires
anf_Fires.sf <- county_Fires.sf %>%
  st_transform(crs = st_crs(anfbounds.sf)) %>%
  st_intersection(anfbounds.sf)

#filtered to lighting fires
anf_LF.sf <- anf_Fires.sf %>%
  filter(NWCG_GENERAL_CAUSE == "Natural")
```


lightning data set:
```{r}
#gives lighting data for each individual county based on fips code
lightning.df <- list.files(path = "C:/Users/zlaw9/OneDrive/GITHUB/KDBI code/FIPS_LightningData",
                  pattern = "*.csv", full.names = TRUE) %>%
  lapply(read_csv) %>%
  bind_rows

lightning.df <- lightning.df %>%
  mutate(SEQDAY = as.Date(SEQDAY),
         DAY = day(SEQDAY),
         MONTH = month(SEQDAY),
         YEAR = year(SEQDAY)) %>%
#missing data beyond 5/20/2013 for FIPS #12037. Remove last 5 rows from data set. This addresses the parsing failure and removes data that is NA.
  filter(SEQDAY <=  "2013-05-20")

#Combine total lightning strikes in ANF counties by date.
lightning.df <- lightning.df %>%
  group_by(SEQDAY) %>%
  summarise(LightningCount = sum(FCOUNT_NLDN))
```

Viewing fires within the Apalachicola National Forest (437 observations)
```{r}
tmap_mode("view")

tm_shape(anfbounds.sf) +
  tm_borders()

tm_shape(anf_LF.sf) +
  tm_dots(col = "orange")
```

##Exploratory Analysis

Cause of Fires in the Apalachicola National Forest
Natural fires account for nearly 40% of fires in the ANF
```{r}
#table(Fires.sf$NWCG_GENERAL_CAUSE)

df <- anf_Fires.sf %>%
  st_drop_geometry() %>%
  group_by(NWCG_GENERAL_CAUSE) %>%
  summarize(nF = n(),
            perF = nF/nrow(anf_Fires.sf))

ggplot(df,
       mapping = aes(y = reorder(NWCG_GENERAL_CAUSE, perF),
                     x = perF,
                     fill = perF)) +
  geom_col() +
  scale_fill_distiller(palette = "Oranges",
                       direction = 1,
                       guide = "none") +
  scale_x_continuous(labels = percent) +
  ylab("") + xlab("") +
  labs(title = "Lightning is the predominant spark for wildfires in the Apalachicola National Forest",
       subtitle = "Based on data from 1992-2018",
       caption = "Data source: Short, Karen (2021)") +
  theme_minimal()
```

Locations of lightning fires in the ANF
```{r}
ggplot() +
  geom_sf(data = anfbounds.sf, fill = "transparent") +
  geom_sf(data = anf_LF.sf,
          mapping = aes(col = FIRE_SIZE_CLASS)) +
  scale_color_brewer(palette = "Oranges",
                     direction = 1,
                     name = "Size Class: Acres Burned",
                     labels = c(
                       "A: 0-0.25",
                       "B: 0.26-9.9",
                       "C: 10.0-99.9",
                       "D: 100-299",
                       "E: 300-999",
                       "F: 1000-4999",
                       "G: 5000+")) +
  theme_bw() +
  labs(title = "Location of natural-caused wildfires in the Apalachicola National Forest (1992-2018)",
       subtitle = "Darker color points indicates the fire resulted in a larger burn area",
       caption = "Data source: Short, Karen (2021)")
```

Plot the number of lightning fires per month
Over 80% of lightning-sparked wildfires in the ANF occur during May-July
```{r}
df <- anf_LF.sf %>%
  st_drop_geometry() %>%
  mutate(MonthF = factor(month.name[month(DISCOVERY_)], 
                         levels = rev(month.name), 
                         ordered = TRUE)) %>%
  group_by(MonthF, .drop = FALSE) %>%
  summarize(nF = n(),
            perF = nF/nrow(anf_LF.sf))

ggplot(data = df,
       mapping = aes(y = MonthF, 
                     x = perF,
                     fill = perF)) +
  geom_col() +
  scale_fill_distiller(palette = "Oranges",
                       direction = 1,
                       guide = FALSE) +
  scale_x_continuous(labels = percent) +
  xlab("") + ylab("") +
  labs(title = "Over 80% of lightning-sparked wildfires in the Apalachicola National Forest occur during May-July",
       subtitle = "Percentage of all lightning-sparked wildfires by month",
       caption = "Period of record: 1992-2015, Data source: Short, Karen (2017)") +
  theme_minimal() 
```

Plot average monthly rainfall and max temperatures
```{r}
df <- TLH.df %>%
  filter(Year >= 1941 & Year <= 2019) %>%
  group_by(month) %>%
  summarize(totalRain = sum(Rainfall24mm),
            avgMonthlyTotalRain = totalRain/(2019 - 1941 + 1),
            avgDailyHighTemp = mean(MaxTemp))

p1 <- ggplot(data = df,
             mapping = aes(x = month, y = avgMonthlyTotalRain, fill = avgMonthlyTotalRain)) +
        geom_col() +
        scale_fill_distiller(palette = "Greens",
                         direction = 1, 
                         guide = 'none') +
        theme_dark() +
        labs(x = "", y = "(mm)",
             title = "Average monthly rainfall amount in the Apalachicola National Forest",
             subtitle = "1941-2019")


p2 <- ggplot(data = df,
             mapping = aes(x = month, y = avgDailyHighTemp, color = avgDailyHighTemp)) +
        geom_point(size = 4) +
        scale_color_distiller(palette = "Oranges",
                              direction = 1, 
                              guide = 'none') +
        scale_y_continuous(limits = c(60, 100)) +
        theme_dark() +
        labs(x = "", y = "(Â°F)",
             title = "Average daily high temperature in the Apalachicola National Forest",
             subtitle = "1941-2019")

p1 / p2
```

Monthly average soil moisture deficit.
```{r}
TLH.df %>%
  filter(Year >= 1941 & Year <= 2019) %>%
  mutate(MonthF = factor(month.name[month(Date)], 
                         levels = rev(month.name), 
                         ordered = TRUE)) %>%
  group_by(MonthF, .drop = FALSE) %>%
  summarize(AvgSoilMoistureDeficit = mean(Qlm)) %>%
ggplot(mapping = aes(y = MonthF, 
                     x = AvgSoilMoistureDeficit,
                     fill = AvgSoilMoistureDeficit)) +
  geom_col() +
  scale_fill_gradientn(colors = terrain.colors(5),
                       guide = 'none') +
  labs(x = "", y = "",
       title = "May through November is the dry season in the Apalachicola National Forest",
       subtitle = "Average soil moisture deficit (mm)",
       caption = "Period of record: 1941-2019, Data source: NWSFO Tallahassee") +
  theme_dark() 
```

Another interpretation of soil moisture plot
```{r}
TLH.df %>%
  filter(Year >= 1941 & Year <= 2019) %>%
  group_by(month, Year) %>%
  summarise(Avg = mean(Qlm)) %>%
  ggplot(aes(x = Year, y = Avg, color = Avg)) +
  geom_smooth(method = lm, se = FALSE, color = "gray70") +
  geom_point() +  
  scale_color_gradientn(colors = terrain.colors(5), guide = "none") +
  scale_y_continuous(limits = c(0, 201)) +
  scale_x_continuous(limits = c(1940, 2020), breaks = c(1950, 1980, 2010)) +
  ylab("") + xlab("") +
  facet_wrap(~ month, ncol = 12) +
  theme_dark() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Risk of wildfires is increasing in the Apalachicola National Forest.",
       subtitle = "Monthly average soil moisture deficit (mm) by year with trend line (gray)", 
       caption = "Period of record: 1941-2019, Data source: NWSFO Tallahassee") 
```
