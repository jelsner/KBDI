---
title: "Climate Trends in Daily Temperatures"
output: html_document
editor_options: 
  chunk_output_type: console
---

1. Writing is thinking, 
2. 1 article, 1 question, 1 finding, 
3. it's not a review of the literature, it's an argument about why we need your paper

What day(s) of the year show the largest long-term trends in max/min temperatures? Corollary: what day(s) of the year do not show a normal distribution in max/min temperatures?

R version 4.1.0 (2021-05-18) -- "Camp Pontanezen"

## Get the required packages
```{r}
library(tidyverse)
library(lubridate)
library(broom)
```

## Get TLH airport daily weather data

NWS Tallahassee daily weather data:
https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00093805/detail
https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt
Column explanations: https://docs.google.com/document/d/1q2WEpXndpMx9lUq-0ON63GojkaOzixrGyYEhI_xkPtw/edit?usp=sharing
AWND = Average daily wind speed (tenths of meters per second) 

Import the summary of the day data and add columns to the data frame.
```{r}
TLH.df <- read.csv(file = 'Data/TLH_Daily1940-2020.csv',
                   stringsAsFactors = FALSE,
                   header = TRUE) %>%
  mutate(Date = as.Date(DATE)) %>%
  mutate(Year = year(Date), 
         month = month(Date, label = TRUE, abbr = TRUE),
         doy = yday(Date),
         MaxTemp = TMAX,
         MinTemp = TMIN) %>%
  filter(Year <= 2020 & Year >= 1943)

# Missing temperatures filled in from NCDC daily summaries https://gis.ncdc.noaa.gov/maps/ncei/summaries/daily

TLH.df$MaxTemp[TLH.df$Date == "2005-07-08"] <- 95
TLH.df$MinTemp[TLH.df$Date == "2005-07-08"] <- 72
TLH.df$MinTemp[TLH.df$Date == "2002-10-08"] <- 67 # Quincy

TLH.df <- TLH.df |>
  mutate(AvgTemp = (MaxTemp + MinTemp) / 2)

( AnnualMeanTemperatures <- TLH.df %>%
  group_by(Year) %>%
  summarize(AvgHighTemp = mean(MaxTemp),
            AvgLowTemp = mean(MinTemp),
            AvgMeanTemp = mean(AvgTemp)) )
```

Plot annual mean temperatures.
```{r}
AnnualMeanTemperatures |>
  pivot_longer(cols = c(AvgHighTemp, AvgLowTemp, AvgMeanTemp)) |>
  ggplot(mapping = aes(x = Year, y = value, color = name)) +
    geom_point() +
    geom_smooth() +
  theme_minimal()
```

Non-normality in daily high and low temperatures
```{r}
library(moments)
library(nortest)

TLH.df |>
  group_by(doy) |>
  summarize( AvgTempByDoY = mean(AvgTemp),
             SDTempByDoY = sd(AvgTemp),
             SkewTempByDoY = skewness(AvgTemp) ) |>
  ggplot(mapping = aes(x = doy, y = SkewTempByDoY)) +
    geom_point() +
    geom_smooth()

normTest <- 
  TLH.df |>
#  filter(Year >= 1990) |>
  group_by(doy) |>
  summarize(pvalueS = shapiro.test(AvgTemp)$p.value,
            pvalueAD = ad.test(AvgTemp)$p.value) 

normTest$doy[normTest$pvalueS > .05]
normTest$doy[normTest$pvalueAD > .05]
```

Compute long-term trends in day-of-year high and low temperatures.
```{r}
( Trends <- 
  TLH.df |> 
    mutate(MaxTemp = (MaxTemp - 32) * 5/9) |>
#  filter(Year >= 1990) |>
    group_by(doy) |>
    do(tidy(lm(MaxTemp ~ Year, data = .))) |>
    filter(term == "Year") |>
    mutate(Date = as.Date(doy - 1, origin = "2020-01-01"),
           estimate = estimate * 10,
           std.error = std.error * 10,
           ymax = estimate + std.error,
           ymin = estimate - std.error) )

Trends |> 
  arrange(desc(statistic))

TLH.df |>
  filter(doy %in% c(26, 350, 192)) |>
  select(Year, MaxTemp, Date, doy) |>
  ggplot(mapping = aes(x = Year, y = MaxTemp)) +
    geom_point() +
    geom_smooth(method = lm) +
  facet_wrap(~ doy) +
  theme_minimal()
```

Plot trends.
```{r}
p1 <- Trends |>
  ggplot(mapping = aes(x = doy, y = estimate, color = statistic) ) +
  scale_y_continuous(limits = c(-1.2, 1.2)) +
  geom_hline(yintercept = 0, color = "gray70") +
  scale_color_distiller(palette = "RdBu", 
                        limits = c(-1, 1) * max(abs(Trends$statistic)),
                        guide = 'none') +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = ymin, ymax = ymax)) +
  scale_x_continuous(position = "bottom", 
                     breaks = c(1, 32, 61, 92, 122, 153, 183, 214, 245, 275, 306, 336) + 13,
                     labels = month.name) +
  theme_minimal() +
  labs(title = "Long-term (1943-2020) trends in daily high temperature (Â°C/decade) in Tallahassee, Florida", 
       subtitle = "Darker colors indicate greater evidence against a no-change hypothesis", 
       x = "", y = "")
```

Annotate plot. http://jenrichmond.rbind.io/post/idhtg-how-to-annotate-plots/

```{r}
  annotate("text", x = 46, y = -1, label = "Most cooling day: January 26") +
  annotate("text", x = 130, y = .8, label = "Most significant warming day: July 10 or 11") +
  annotate("text", x = 280, y = 1, label = "Most warming day: December 15 or 16") 
  
arrows <- 
  tibble(
    x1 = c(187, 212),
    x2 = c(205, 204),
    y1 = c(6000, 3000), 
    y2 = c(5500, 3500)
  )

arrows

p1 +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray20", curvature = -0.3)
```

Use `ggdist` package from Matthew Kay.
```{r}
library(ggdist)
# theme_set(theme_ggdist())

TLH.df |>
  ggplot(mapping = aes(x = doy, y = MaxTemp)) +
  stat_gradientinterval()

```