---
title: "Long-term Trends in Day-Of-Year Temperatures"
output: html_document
editor_options: 
  chunk_output_type: console
---

Tallahassee is hot and getting hotter. Examples
https://iopscience.iop.org/article/10.1088/2515-7620/ab27cf

Key finding of this research: The most significant warming trends are occurring during summer although the largest changes occur during fall and winter.

This increased warming averaged over decades amounts to about 

While a warmer than usual day in December will be experienced as quite pleasant a warmer than usual day in July likely will be experienced as dreadfully uncomfortable and potential quite dangerous to health.

According to the 6th IPCC assessment, the observed warming in 2010-2019 relative to 1850-1900 is 1.07C. For hot extremes, the evidence is mostly drawn from changes in metrics based on daily maximum temperatures.

But how individuals and communities experience climate change is local.

People of all political leanings highly value listening, openness, and talking about science in the context of society and community. Heslop, C., Dudo, A., and Copple, J. (August, 2021). Communicating science across political divides. Center for Media Engagement. https://mediaengagement.org/research/communicating-science- across-political-divides

Quote: "Throughout the WGI report and unless stated otherwise, uncertainty is quantified using 90% uncertainty intervals. The 90% uncertainty interval, reported in square brackets [x to y], is estimated to have a 90% likelihood of covering the value that is being estimated. The range encompasses the median value and there is an estimated 10% combined likelihood of the value being below the lower end of the range (x) and above its upper end (y). Often the distribution will be considered symmetric about the corresponding best estimate, but this is not always the case."

"For hot extremes, the evidence is mostly drawn from changes in metrics based on daily maximum temperatures" "There has been widespread evidence of human influence on various aspects of temperature extremes, at global, continental, and regional scales. This includes attribution to human influence of observed changes in intensity, frequency, and duration and other relevant characteristics at global and continental scales." But very little work at individual locations. What days of the year are warming the fastest in a particular location. Requires a long-term record

https://rmets.onlinelibrary.wiley.com/doi/10.1002/joc.4688 Diurnal asymmetry to the observed global warming

We compute day-of-year trends in min and max temperature and use descriptive statistics to examine the range, distribution, and extremes of these trends.

How has each day changed over the years?

What days of the year have warmed the most? What days of the year have cooled the most? 

show the biggest long-term (climate) trends in max/min temperatures? Corollary: what day(s) of the year do not show a normal distribution in max/min temperatures?

Why is this important? Climate change on the scale relevant to our daily lives.

The paper is exploratory. We do not have a hypothesis in mind though we do expect to see more days with upward than downward trends with perhaps a greater number of days with upward trends in low temperatures compared to the number of days with upward trends in high temperatures.

R version 4.1.0 (2021-05-18) -- "Camp Pontanezen"

## Get the required packages
```{r}
library(tidyverse)
library(lubridate)
library(broom)
library(patchwork)
library(ggdist)
```

## Get TLH airport daily weather data

NWS Tallahassee daily weather data:
https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00093805/detail
https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt
Column explanations: https://docs.google.com/document/d/1q2WEpXndpMx9lUq-0ON63GojkaOzixrGyYEhI_xkPtw/edit?usp=sharing
AWND = Average daily wind speed (tenths of meters per second) 

Import the summary-of-the-day data and add columns to the data frame.
```{r}
TLH.df <- read.csv(file = 'Data/TLH_Daily1940-2020.csv') |>
  mutate(Date = as.Date(DATE)) |>
  mutate(Year = year(Date), 
         month = month(Date, label = TRUE, abbr = TRUE),
         doy = yday(Date),
         MaxTemp = TMAX,
         MinTemp = TMIN) |>
  filter(Year <= 2020 & Year >= 1943)

Other.df <- read.csv(file = 'Data/LVG_Daily1940-2020.csv') |>
  mutate(Date = as.Date(DATE)) |>
  mutate(Year = year(Date), 
         month = month(Date, label = TRUE, abbr = TRUE),
         doy = yday(Date),
         MaxTemp = TMAX,
         MinTemp = TMIN) |>
  filter(Year <= 2020 & Year >= 1943)


# Missing temperatures filled in from NCDC daily summaries https://gis.ncdc.noaa.gov/maps/ncei/summaries/daily

TLH.df$MaxTemp[TLH.df$Date == "2005-07-08"] <- 95
TLH.df$MinTemp[TLH.df$Date == "2005-07-08"] <- 72
TLH.df$MinTemp[TLH.df$Date == "2002-10-08"] <- 67 # Quincy
```

TLH.df <- Other.df  # Albany, GA shows more cooling days than warming days. Why? Milwaukee shows more warming days than cooling days like Tallahassee. Las Vegas shows more warming days and all warming nights.

Diurnal temperature range (DTR) is an index that combines daily high and low temperatures. Since processes that result in high temperature are different than processes that result in low temperature, the metric is not useful for understanding the physics related to long-term trends in day-of-year temperature.
```{r}
TLH.df <- TLH.df |>
  mutate(AvgTemp = (MaxTemp + MinTemp) / 2,
         DTR = MaxTemp - MinTemp)
```

Annual mean daily highs and lows are warming since the 1970s.
```{r}
( AnnualMeanTemperatures <- TLH.df %>%
  group_by(Year) |>
  summarize(AvgHighTemp = mean(MaxTemp, na.rm = TRUE),
            AvgLowTemp = mean(MinTemp, na.rm = TRUE),
            AvgMeanTemp = mean(AvgTemp, na.rm = TRUE),
            AvgDTR = mean(DTR, na.rm = TRUE)) )

AnnualMeanTemperatures |>
  pivot_longer(cols = c(AvgHighTemp, AvgLowTemp)) |>
  ggplot(mapping = aes(x = Year, y = value, color = name)) +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_discrete(guide = "none") +
    geom_point() +
    geom_smooth() +
  theme_minimal() +
  labs(title = "Annual mean daily high and low temperatures (°F)",
       subtitle = "Tallahasee, Florida (1943-2020)",
       x = "", y = "")

AnnualMeanTemperatures |>
  ggplot(mapping = aes(x = Year, y = AvgDTR)) +
  scale_y_continuous(limits = c(NA, NA)) +
    geom_point() +
    geom_smooth() +
  theme_minimal() +
  labs(title = "Annual mean DTR (°F)",
       subtitle = "Tallahasee, Florida (1943-2020)",
       x = "", y = "")
```

Histogram of daily high temperature.
```{r}
labels <- c(paste0(seq(30, 100, by = 10), "°", " F"))

p1 <- TLH.df |> 
ggplot(mapping = aes(x = MaxTemp)) + 
  geom_histogram(binwidth = 1, 
                 mapping = aes(fill = ..count..)) +
  scale_fill_viridis_c(guide = "none") +
  scale_x_continuous(breaks = seq(30, 100, by = 10),
                     labels = labels) +
  theme_minimal() +
  labs(title = "Frequency of daily high temperatures",
       subtitle = "Tallahassee, Florida (1943-2020)",
       x = "", y = "")

arrows <- 
  tibble(
    x1 = c(75),
    x2 = c(89),
    y1 = c(1025), 
    y2 = c(1200)
  )

p1 +
  annotate("text", x = 60, y = 1000, label = "The most common high temperature is 90° F") +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(.08, "inch")), size = .5,
    color = "gray20", curvature = -.3)
```

Histogram of daily low temperature.
```{r}
labels <- c(paste0(seq(10, 80, by = 10), "°", " F"))

p2 <- TLH.df |> 
ggplot(mapping = aes(x = MinTemp)) + 
  geom_histogram(binwidth = 1, 
                 mapping = aes(fill = ..count..)) +
  scale_fill_viridis_c(guide = "none") +
  scale_x_continuous(breaks = seq(10, 80, by = 10),
                     labels = labels) +
  theme_minimal() +
  labs(title = "Frequency of daily low temperatures",
       subtitle = "Tallahassee, Florida (1943-2020)",
       x = "", y = "")

arrows <- 
  tibble(
    x1 = c(50),
    x2 = c(71),
    y1 = c(1250), 
    y2 = c(1460)
  )

p2 +
  annotate("text", x = 48, y = 1200, label = "The most common low temperature is 72° F") +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(.08, "inch")), size = .5,
    color = "gray20", curvature = -.3)

labels <- c(paste0(seq(0, 50, by = 10), "°", " F"))
TLH.df |> 
ggplot(mapping = aes(x = DTR)) + 
  geom_histogram(binwidth = 1, 
                 mapping = aes(fill = ..count..)) +
  scale_fill_viridis_c(guide = "none") +
  scale_x_continuous(breaks = seq(0, 50, by = 10),
                     labels = labels) +
  theme_minimal() +
  labs(title = "Frequency of DTR",
       subtitle = "Tallahassee, Florida (1943-2020)",
       x = "", y = "")
```

Statistics of day-of-year max
```{r}
( StatsMax <- 
  TLH.df |>
  group_by(doy) |>
  summarize(Avg = mean(MaxTemp, na.rm = TRUE),
            Highest = max(MaxTemp, na.rm = TRUE),
            Lowest = min(MaxTemp, na.rm = TRUE),
            Q75 = quantile(MaxTemp, prob = .75, na.rm = TRUE),
            Q25 = quantile(MaxTemp, prob = .25, na.rm = TRUE)) |>
   mutate(Date = as.Date(doy - 1, origin = "2020-01-01")) )

StatsMax |>
  ggplot(mapping = aes(x = doy, y = Avg ) ) +
  scale_y_continuous(limits = c(NA, NA)) +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = Lowest, ymax = Highest)) +
  geom_errorbar(mapping = aes(ymin = Q25, ymax = Q75), width = .5) +
  scale_x_continuous(position = "bottom", 
                     breaks = c(1, 32, 61, 92, 122, 153, 183, 214, 245, 275, 306, 336) + 13,
                     labels = month.name) +
  theme_minimal() 
```

## Polar coordinate plot.

Theme tips from https://dominicroye.github.io/en/2021/climate-circles/
```{r}
labels <- c(paste0(seq(20, 100, by = 20), "°", " F"))

StatsMax |>
  ggplot() +
  geom_hline(yintercept = 100, color = "gray70") +
  geom_linerange(mapping = aes(x = Date,
                               ymax = Highest,
                               ymin = Lowest,
                               color = Avg),
                               size = 1,
                               alpha = 1) +
  geom_point(mapping = aes(x = Date, y = Avg), color = "white", size = .5) +
  scale_color_distiller(palette = "RdBu", guide = "none") +
  scale_y_continuous(limits = c(20, 105),
                     breaks = seq(20, 100, by = 20),
                     labels = labels) +
  scale_x_date(date_breaks = "month", date_labels = "%B") +
  coord_polar(start = pi) +
  theme_dark() +
  theme(axis.text = element_text(colour = "white"),
        axis.title = element_blank(),
        plot.background = element_rect(fill = "gray50"),
        plot.title = element_text(color = "white"),
        plot.subtitle = element_text(color = "white")) +
  labs(title = "Day-of-year high temperatures: average (dot) and range",
       subtitle = "Tallahassee, FL, (1943-2020)")
```

Non-normality in daily high and low temperatures
```{r}
library(moments)
library(nortest)

TLH.df |>
  group_by(doy) |>
  summarize( AvgByDoY = mean(MaxTemp),
             SDByDoY = sd(MaxTemp),
             SkewByDoY = skewness(MaxTemp) ) |>
  ggplot(mapping = aes(x = doy, y = AvgByDoY)) +
    geom_point() +
    geom_smooth()

normTest <- 
  TLH.df |>
  group_by(doy) |>
  summarize(pvalueS = shapiro.test(MaxTemp)$p.value,
            pvalueAD = ad.test(MaxTemp)$p.value) |>
  mutate(Date = as.Date(doy - 1, origin = "2020-01-01"),
         Month = month(Date))

normTest$doy[normTest$pvalueS > .05]
normTest$doy[normTest$pvalueAD > .05]

normTest |>
  group_by(Month) |>
  summarize(nNormalDaysS = sum(pvalueS > .05),
            nNormalDaysAD = sum(pvalueAD > .05))
  
```

Compute long-term trends in day-of-year high temperatures.
```{r}
( Trends <- 
  TLH.df |> 
#    mutate(MaxTemp = (MaxTemp - 32) * 5/9) |>
    group_by(doy) |>
    do(tidy(lm(MaxTemp ~ Year, data = .))) |>
    filter(term == "Year") |>
    mutate(Date = as.Date(doy - 1, origin = "2020-01-01"),
           estimate = estimate,
           std.error = std.error,
           ymax = estimate + std.error,
           ymin = estimate - std.error,
           Daily = "High") )

sum(Trends$estimate > 0)
sum(Trends$estimate < 0)
sum(Trends$estimate > 0) / length(Trends$estimate) * 100

Trends |> 
  arrange(desc(statistic))
```

## Slope graph showing top ten upward doy trends and top ten downward doy trends
https://cran.r-project.org/web/packages/CGPfunctions/vignettes/Using-newggslopegraph.html

Predict values from the linear model for 1950 and 2020. Use these values for start and end of the slopes. Note: need to `ungroup()` first otherwise the `slice()` function will operate on each group.
```{r}
Up <-
  Trends |>
  ungroup() |>
  slice_max(estimate, n = 5) |>
  pull(doy)

Down <-
  Trends |>
  ungroup() |>
  slice_min(estimate, n = 5) |>
  pull(doy)

Largest <- c(Up, Down)

Changes <- TLH.df |> 
  filter(doy %in% Largest) |>
  nest(data = -doy) |>
    mutate(fit = map(data, ~lm(MaxTemp ~ Year, data = .x)),
           augmented = map(fit, augment)) |>
    unnest(augmented) |>
  filter(Year %in% c(1950, 2020)) |>
  mutate(Year = factor(Year, levels = c(1950, 2020), ordered = TRUE),
         Temperature = round(.fitted, 0),
         Date = as.Date(doy - 1, origin = "2020-01-01"),
         DayMonth = paste(day(Date), month.name[month(Date)]) )|>
  select(DayMonth, Year, Temperature) |>
  group_by(DayMonth) |>
  mutate(Difference = Temperature[Year == 2020] - Temperature[Year == 1950],
         Trend = case_when(Difference < 0 ~ muted("blue"),
                           TRUE ~ muted("red"))) |>
  as.data.frame()
```

Make the graph
```{r}
library(CGPfunctions)

custom_colors <- 
  Changes |>
  group_by(DayMonth) |>
  summarize(Color = last(Trend)) |>
  tibble::deframe()

newggslopegraph(Changes, 
                Year, 
                Temperature,
                DayMonth,
                Title = "Days of the year that have warmed and cooled the most in Tallahassee, Florida",
                SubTitle = "Daily high temperature (° F). Based on data over the period 1943-2020",
                Caption = NULL,
                LineThickness = .5,
                YTextSize = 4,
                LineColor = custom_colors)
```

Histogram of trends
```{r}
library(scales)

breaks_x <- seq(-12, 12, by = 2)
labels_x <- c(paste0(seq(-12, 12, by = 2), "°", " F"))

breaks_y <- 366 * seq(0, .2, by = .05)
labels_y <- c("0", paste0(seq(.05, .2, by = .05) * 100, "%"))

Trends |>
  mutate(Change = estimate * (2020 - 1943 + 1),
         Colors = case_when(Change < 0 ~ "A",
                           TRUE ~ "B")) |>
  ggplot(mapping = aes(x = Change, fill = Colors)) +
    geom_histogram(binwidth = 1, 
                   color = "white",
#                   fill = "gray80",
                   center = .5) +
    geom_rug(mapping = aes(color = Change)) +
    scale_y_continuous(breaks = breaks_y,
                       labels = labels_y) +
    scale_x_continuous(breaks = breaks_x,
                       labels = labels_x) +
    scale_color_gradient2(low = muted("blue"),
                          mid = "white",
                          high = muted("red"),
                          midpoint = 0,
                          guide = 'none') +
    scale_fill_manual(values = c(muted("blue"), muted("red")),
                      guide = "none") +
    geom_hline(yintercept = breaks_y, color = "white") +
    labs(title = "More days have warmed than cooled in Tallahassee, FL",
         subtitle = "Percentage of all days of the year that have warmed (or cooled) binned by 1° F change: 1943-2020",
         x = "", y = "") +
    theme_minimal() +
    theme(panel.grid = element_blank())
```

Plot largest trends.
```{r}
labels <- c(paste0(seq(40, 100, by = 20), "°", " F"))

( p3 <- TLH.df |>
  filter(doy %in% c(26, 350, 192)) |>
  mutate(Day = factor(case_when(Day = doy == 26 ~ "26 January\n Most cooling",
                         Day = doy == 350 ~ "15/16 December\n Most warming",
                         Day = doy == 192 ~ "10/11 July\n Most significant warming"), 
                      levels = c("26 January\n Most cooling", 
                                 "10/11 July\n Most significant warming", "15/16 December\n Most warming"))) |>
  select(Year, MaxTemp, Date, doy, Day) |>
  ggplot(mapping = aes(x = Year, y = MaxTemp)) +
    geom_smooth(method = lm, mapping = aes(color = Day)) +
    geom_point(color = "gray70") +
  facet_wrap(~ Day) +
  scale_x_continuous(breaks = seq(50, 2010, by = 20)) +
  scale_y_continuous(limits = c(35, 105), breaks = seq(40, 100, by = 20), labels = labels) +
  scale_color_manual(values = c("skyblue", "red3", "salmon"), guide = "none") +
  theme_minimal() +
  labs(x = "", y = "") )
```

Plot trends using polar coordinate plot. Here trends are F/year with ymax, ymin +/- 1 s.e.
```{r}
labels <- c(paste0(seq(-.2, .2, by = .1), "° F/yr"))

Trends |>
  ggplot() +
  geom_hline(yintercept = 0, color = "gray70") +
  geom_linerange(mapping = aes(x = Date,
                               ymax = ymax,
                               ymin = ymin,
                               color = estimate),
                               size = 1,
                               alpha = 1) +
  geom_point(mapping = aes(x = Date, y = estimate), color = "white", size = .5) +
  scale_color_distiller(palette = "RdBu", guide = "none") +
  scale_y_continuous(limits = c(-.2, .2),
                     breaks = seq(-.2, .2, by = .1),
                     labels = labels) +
  scale_x_date(date_breaks = "month", date_labels = "%B") +
  coord_polar(start = pi) +
  theme_dark() +
  theme(axis.text = element_text(colour = "white"),
        axis.title = element_blank(),
        plot.background = element_rect(fill = "gray50"),
        plot.title = element_text(color = "white"),
        plot.subtitle = element_text(color = "white")) +
  labs(title = "Day-of-year trends in high temperatures: average (dot) and range",
       subtitle = "Tallahassee, FL, (1943-2020)")
```

Plot trends on a line graph with annotation
```{r}
TrendsMax <- 
  TLH.df |> 
    mutate(MaxTemp = (MaxTemp - 32) * 5/9) |>
    group_by(doy) |>
    do(tidy(lm(MaxTemp ~ Year, data = .))) |>
    filter(term == "Year") |>
    mutate(Date = as.Date(doy - 1, origin = "2020-01-01"),
           estimate = estimate * 10,
           std.error = std.error * 10,
           ymax = estimate + std.error,
           ymin = estimate - std.error,
           Daily = "High")

( p4 <- TrendsMax |>
  ggplot(mapping = aes(x = doy, y = estimate, color = statistic) ) +
  scale_y_continuous(limits = c(-1.5, 1.5)) +
  geom_hline(yintercept = 0, color = "gray70") +
  scale_color_distiller(palette = "RdBu", 
                        limits = c(-1, 1) * max(abs(TrendsMax$statistic)),
                        guide = 'none') +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = ymin, ymax = ymax)) +
  scale_x_continuous(position = "bottom", 
                     breaks = c(1, 32, 61, 92, 122, 153, 183, 214, 245, 275, 306, 336) + 13,
                     labels = month.name) +
  theme_minimal() +
  labs(title = "Long-term (1943-2020) trends in day-of-year high temperatures (°C/decade), Tallahassee, Florida", 
       subtitle = "Darker colors indicate greater evidence against a no-change hypothesis", 
       x = "", y = "") )
```

Annotate the plot with text and arrows. http://jenrichmond.rbind.io/post/idhtg-how-to-annotate-plots/
```{r}
arrows <- 
  tibble(
    x1 = c(46, 130, 300),
    x2 = c(26.5, 191.5, 349.5),
    y1 = c(-.95, .75, 1.15), 
    y2 = c(-.525, .48, .8)
  )

( p4 <- p4 + 
  annotate("text", x = 46, y = -1, label = "Most cooling: 26 January") +
  annotate("text", x = 130, y = .8, label = "Most significant warming: 10/11 July") +
  annotate("text", x = 300, y = 1.2, label = "Most warming: 15/16 December") +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(.08, "inch")), size = .5,
    color = "gray50", curvature = .3) )

library(patchwork)

p4/p3
```

Compute long-term trends in day-of-year low temperatures.
```{r}
( TrendsMin <- 
  TLH.df |> 
    mutate(MinTemp = (MinTemp - 32) * 5/9) |>
#  filter(Year >= 1990) |>
    group_by(doy) |>
    do(tidy(lm(MinTemp ~ Year, data = .))) |>
    filter(term == "Year") |>
    mutate(Date = as.Date(doy - 1, origin = "2020-01-01"),
           estimate = estimate * 10,
           std.error = std.error * 10,
           ymax = estimate + std.error,
           ymin = estimate - std.error,
           Daily = "Low") )

sum(TrendsMin$estimate > 0)
sum(TrendsMin$estimate < 0)
sum(TrendsMin$estimate > 0) / length(TrendsMin$estimate) * 100

TrendsMin |> 
  arrange(desc(statistic))
```

```{r}
Trends <- rbind(TrendsMax, TrendsMin)
Trends |>
  ggplot(mapping = aes(y = estimate, x = Daily, color = estimate)) +
    stat_slab(color = "gray80", fill = "gray80", scale = .5) +
    geom_point(shape = "_", size = 4) + 
#    stat_halfeye() +
    scale_color_gradient2(low = "blue",
                          mid = "white",
                          high = "red",
                          midpoint = 0,
                          guide = 'none') +
    scale_y_continuous(limits = c(-1.5, 1.5)) +
    theme_minimal() +
    labs(x = "", y = "", title = "Day-of-year trends in high and low temperatures (°C/decade)")
```

```{r}
labels <- c(paste0(seq(20, 80, by = 20), "°", " F"))

( p5 <- TLH.df |>
  filter(doy %in% c(26, 335, 193)) |>
  mutate(Day = factor(case_when(Day = doy == 26 ~ "26 January\n Most cooling",
                         Day = doy == 335 ~ "30 November/1 December\n Most warming",
                         Day = doy == 193 ~ "11/12 July\n Most significant warming"), 
                      levels = c("26 January\n Most cooling", 
                                 "11/12 July\n Most significant warming", 
                                 "30 November/1 December\n Most warming"))) |>
  select(Year, MinTemp, Date, doy, Day) |>
  ggplot(mapping = aes(x = Year, y = MinTemp)) +
    geom_smooth(method = lm, mapping = aes(color = Day)) +
    geom_point(color = "gray70") +
  facet_wrap(~ Day) +
  scale_x_continuous(breaks = seq(1950, 2010, by = 20)) +
  scale_y_continuous(limits = c(15, 85), breaks = seq(20, 80, by = 20), labels = labels) +
  scale_color_manual(values = c("skyblue", "red3", "salmon"), guide = "none") +
  theme_minimal() +
  labs(x = "", y = "") )

( p6 <- Trends |>
  ggplot(mapping = aes(x = doy, y = estimate, color = statistic) ) +
  scale_y_continuous(limits = c(-1.2, 1.2)) +
  geom_hline(yintercept = 0, color = "gray70") +
  scale_color_distiller(palette = "RdBu", 
                        limits = c(-1, 1) * max(abs(Trends$statistic)),
                        guide = 'none') +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = ymin, ymax = ymax)) +
  scale_x_continuous(position = "bottom", 
                     breaks = c(1, 32, 61, 92, 122, 153, 183, 214, 245, 275, 306, 336) + 13,
                     labels = month.name) +
  theme_minimal() +
  labs(title = "Long-term (1943-2020) trends in day-of-year low temperatures (°C/decade), Tallahassee, Florida", 
       subtitle = "Darker colors indicate greater evidence against a no-change hypothesis", 
       x = "", y = "") )

arrows <- 
  tibble(
    x1 = c(56, 160, 300),
    x2 = c(26.5, 192.5, 335),
    y1 = c(-1.1, .75, 1.15), 
    y2 = c(-.815, .287, .671)
  )

( p6 <- p6 + 
  annotate("text", x = 66, y = -1.15, label = "Most cooling: 26 January") +
  annotate("text", x = 130, y = .8, label = "Most significant warming: 11/12 July") +
  annotate("text", x = 300, y = 1.2, label = "Most warming: 30 November/1 December") +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(.08, "inch")), size = .5,
    color = "gray50", curvature = .3) )

p6/p5
```

## Multilevel model
```{r}
library(brms)
```

From: https://paul-buerkner.github.io/brms/articles/brms_distreg.html

Data
```{r}
dat_smooth <- mgcv::gamSim(eg = 6, n = 200, scale = 2, verbose = FALSE)
head(dat_smooth)

max_temp <- 
  TLH.df |>
  select(MaxTemp, Year, doy) |>
  mutate(doyF = as.factor(doy))
```

Models
```{r}
fit_smooth2 <- brm(
  bf(y ~ s(x1) + s(x2) + (1|fac), sigma ~ s(x0) + (1|fac)),
  data = dat_smooth, family = gaussian(),
  chains = 2, control = list(adapt_delta = 0.95)
)

summary(fit_smooth2)

plot(conditional_effects(fit_smooth2), points = TRUE, ask = FALSE)
```



First make a tibble composed of tibbles with `group_by()` followed by `nest()`.
```{r}
by_doy <- TLH.df |>
  group_by(doy) |>
  nest()

head(by_doy)

by_doy$data[[1]]
```

Next fit a linear model to the first doy. Could not get the `update()` function to work. Crashes the session!
```{r}
fit0.1 <- lm(formula = MaxTemp ~ Year, 
           data = by_doy$data[[1]])

library(brms)

fit1.1 <-
  brm(data = by_doy$data[[1]],
      formula = MaxTemp ~ Year,
      prior = prior(normal(0, 10), class = b),
      iter = 4000, chains = 4, cores = 4,
      seed = 31415,
      file = "fits/fit1.1")

fit1.2 <-
  update(fit1.1, 
         newdata = by_doy$data[[2]],
         control = list(adapt_delta = .9),
         file = "fits/fit1.2")

fit1.2 <-
  brm(data = by_doy$data[[2]],
      formula = MaxTemp ~ Year,
      prior = prior(normal(0, 10), class = b),
      iter = 4000, chains = 4, cores = 4,
      seed = 31415)
```

remove.packages("rethinking")
remove.packages("rstan")


